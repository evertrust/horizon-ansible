---
- name: Centralized enrollment

  vars_files:
    - ../../../credentials.yml

  hosts: "{{ hosts }}"

  tasks:
  - name: Test centralize enrollment without problems
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-2048"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "test"
        owner: "test"


  - name: Test centralize enrollment with wrong endpoint
    evertrust.horizon.horizon_enroll:

        endpoint: "http://test.com"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-2048"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "test"
        owner: "test"


  - name: Test centralize enrollment with unidentified profile
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "InexistantProfile"
        mode: "centralized"
        key_type: "rsa-2048"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "test"
        owner: "test"


  - name: Test centralize enrollment with wrong key_type
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-12"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "test"
        owner: "test"


  - name: Test centralize enrollment without password (on profile with a required manual password)
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-2048"
        # password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "test"
        owner: "test"



  - name: Test centralize enrollment with unexistant label
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-2048"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          unexistantLabel: "test"
        team: "test"
        owner: "test"


  - name: Test centralize enrollment with unexistant team
    evertrust.horizon.horizon_enroll:

        endpoint: "{{ endpoint }}"
        x_api_id: "{{ id }}"
        x_api_key: "{{ key }}"

        profile: "{{ profile }}"
        mode: "centralized"
        key_type: "rsa-2048"
        password: "{{ password }}"
        
        subject:
          cn.1: "my cn ansible"
        sans:
          dnsname.1: "my dns ansible"
        labels: 
          label1: "test"
        team: "UnexistantTeam"
        owner: "test"