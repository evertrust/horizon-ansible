- name: Test centralize enrollment without problems
  evertrust.horizon.horizon_enroll:

    endpoint: "https://horizon-demo.evertrust.fr"
    x_api_id: "{{ x_api_id }}"
    x_api_key: "{{ x_api_key }}"

    profile: "AnsibleDefaultTLSServerClient"
    mode: "centralized"
    key_type: "rsa-2048"
      
    subject:
      cn.1: "IntegrationTestCI"
    sans:
      dnsname.1: "AnsibleTest"
    labels: 
      business_unit: "BU1"
      ansible_host: "localhost"
    # team: "test"
    # owner: "test"
  
  register: data

- copy: content="{{ data.certificate.certificate }}" dest="/PEM.pem"

- name: Test centralize enrollment with unidentified profile
  evertrust.horizon.horizon_enroll:

    endpoint: "https://horizon-demo.evertrust.fr"
    x_api_id: "{{ x_api_id }}"
    x_api_key: "{{ x_api_key }}"

    profile: "InexistantProfile"
    mode: "centralized"
    key_type: "rsa-2048"
        
    subject:
      cn.1: "TestWithoutProfile"
    sans:
      dnsname.1: "TestWithoutProfile"
    labels: 
      business_unit: "BU1"
      ansible_host: "localhost"
    # team: "test"
    # owner: "test"

  ignore_errors: yes


- name: Test centralize enrollment with wrong key_type
  evertrust.horizon.horizon_enroll:

    endpoint: "https://horizon-demo.evertrust.fr"
    x_api_id: "{{ x_api_id }}"
    x_api_key: "{{ x_api_key }}"

    profile: "AnsibleDefaultTLSServerClient"
    mode: "centralized"
    key_type: "WrongKeyType-1234"
        
    subject:
      cn.1: "TestWithWrongKeyType"
    sans:
      dnsname.1: "TestWithWrongKeyType"
    labels: 
      business_unit: "BU1"
      ansible_host: "localhost"
    # team: "test"
    # owner: "test"

  ignore_errors: yes


# - name: Test centralize enrollment without password (on profile with a required manual password)
#   evertrust.horizon.horizon_enroll:

#     endpoint: "{{ endpoint }}"
#     x_api_id: "{{ id }}"
#     x_api_key: "{{ key }}"

#     profile: "{{ profile }}"
#     mode: "centralized"
#     key_type: "rsa-2048"
#     # password: "{{ password }}"
        
#     subject:
#       cn.1: "my cn ansible"
#     sans:
#       dnsname.1: "my dns ansible"
#     labels: 
#       label1: "test"
#     team: "test"
#     owner: "test"

#   ignore_errors: yes


- name: Test centralize enrollment with unexistant label
  evertrust.horizon.horizon_enroll:

    endpoint: "https://horizon-demo.evertrust.fr"
    x_api_id: "{{ x_api_id }}"
    x_api_key: "{{ x_api_key }}"

    profile: "AnsibleDefaultTLSServerClient"
    mode: "centralized"
    key_type: "rsa-2048"
      
    subject:
      cn.1: "TestWithUnexistantLabel"
    sans:
      dnsname.1: "TestWithUnexistantLabel"
    labels: 
      unexistantLabel: "test"
    # team: "test"
    # owner: "test"

  ignore_errors: yes


# - name: Test centralize enrollment with unexistant team
#   evertrust.horizon.horizon_enroll:

#     endpoint: "{{ endpoint }}"
#     x_api_id: "{{ id }}"
#     x_api_key: "{{ key }}"
#     profile: "{{ profile }}"
#     mode: "centralized"
#     key_type: "rsa-2048"
#     password: "{{ password }}"
      
#     subject:
#       cn.1: "my cn ansible"
#     sans:
#       dnsname.1: "my dns ansible"
#     labels: 
#       label1: "test"
#     team: "UnexistantTeam"
#     owner: "test"

#   ignore_errors: yes
